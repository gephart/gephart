<?php

namespace Admin\Controller;

use Admin\Response\AdminResponseFactory;
use App\Entity\{{ module.entityName }};
{% for entity in entities %}
use App\Repository\{{ entity }}Repository;
{% endfor %}
use Gephart\ORM\EntityManager;
use Gephart\Routing\Router;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\UploadedFileInterface;

/**
 * @Security ROLE_ADMIN
 * @RoutePrefix /admin/{{ module.slugSingular }}
 */
class {{ module.entityName }}Controller
{

    /**
     * @var Router
     */
    private $router;

    /**
     * @var AdminResponseFactory
     */
    private $template_response;

    /**
     * @var ServerRequestInterface
     */
    private $request;

    /**
     * @var {{ module.entityName }}Repository
     */
    private ${{ module.slugSingular }}_repository;

{% for item in items if item.isRelation and item.slug != module.slugSingular %}
    /**
     * @var {{ item.type }}Repository
     */
    private ${{ item.slug }}_repository;

{% endfor %}
    /**
     * @var EntityManager
     */
    private $entity_manager;

    public function __construct(
        Router $router,
        AdminResponseFactory $template_response,
        ServerRequestInterface $request,
        EntityManager $entity_manager,
{% for item in items if item.isRelation and item.slug != module.slugSingular %}
        {{ item.type }}Repository ${{ item.slug }}_repository,
{% endfor %}
        {{ module.entityName }}Repository ${{ module.slugSingular }}_repository
    )
    {
        $this->router = $router;
        $this->template_response = $template_response;
        $this->request = $request;
{% for item in items if item.isRelation and item.slug != module.slugSingular %}
        $this->{{ item.slug }}_repository = ${{ item.slug }}_repository;
{% endfor %}
        $this->{{ module.slugSingular }}_repository = ${{ module.slugSingular }}_repository;
        $this->entity_manager = $entity_manager;
    }

    /**
     * @Route {
     *  "rule": "/",
     *  "name": "admin_{{ module.slugSingular }}"
     * }
     */
    public function index()
    {
        $postData = $this->request->getParsedBody();
        $filesData = $this->request->getUploadedFiles();

        if (!empty($postData["{{ items[0].slug }}"])) {
            ${{ module.slugSingular }} = new {{ module.entityName }}();
            $this->mapEntityFromArray(${{ module.slugSingular }}, $postData, $filesData);

            $this->entity_manager->save(${{ module.slugSingular }});

            $this->router->redirectTo("admin_{{ module.slugSingular }}");
        }

{% for item in items if item.isRelation %}
        ${{ item.slugPlural }} = $this->{{ item.slug }}_repository->findBy([],["ORDER BY" => "id"]);
{% endfor %}
        ${{ module.slugPlural }} = $this->{{ module.slugSingular }}_repository->findBy([], [
            "ORDER BY" => "id DESC"
        ]);

        return $this->template_response->createResponse("admin/{{ module.slugSingular }}/index.html.twig", [
{% for item in items if item.isRelation %}
            "{{ item.slugPlural }}" => ${{ item.slugPlural }},
{% endfor %}
            "{{ module.slugPlural }}" => ${{ module.slugPlural }}
        ]);
    }

    /**
     * @Route {
     *  "rule": "/edit/{id}",
     *  "name": "admin_{{ module.slugSingular }}_edit"
     * }
     */
    public function edit($id)
    {
        $postData = $this->request->getParsedBody();
        $filesData = $this->request->getUploadedFiles();

        if (!empty($postData["{{ items[0].slug }}"])) {
            ${{ module.slugSingular }} = $this->{{ module.slugSingular }}_repository->find($id);
            $this->mapEntityFromArray(${{ module.slugSingular }}, $postData, $filesData);

            $this->entity_manager->save(${{ module.slugSingular }});

            $this->router->redirectTo("admin_{{ module.slugSingular }}_edit", ["id"=>${{ module.slugSingular }}->getId()]);
        }

{% for item in items if item.isRelation %}
        ${{ item.slugPlural }} = $this->{{ item.slug }}_repository->findBy([],["ORDER BY" => "id"]);
{% endfor %}
        ${{ module.slugSingular }} = $this->{{ module.slugSingular }}_repository->find($id);

        return $this->template_response->createResponse("admin/{{ module.slugSingular }}/edit.html.twig", [
{% for item in items if item.isRelation %}
            "{{ item.slugPlural }}" => ${{ item.slugPlural }},
{% endfor %}
            "{{ module.slugSingular }}" => ${{ module.slugSingular }}
        ]);
    }

    /**
     * @Route {
     *  "rule": "/delete/{id}",
     *  "name": "admin_{{ module.slugSingular }}_delete"
     * }
     */
    public function delete($id)
    {
        ${{ module.slugSingular }} = $this->{{ module.slugSingular }}_repository->find($id);
        $this->entity_manager->remove(${{ module.slugSingular }});

        $this->router->redirectTo("admin_{{ module.slugSingular }}");
    }

    private function mapEntityFromArray({{ module.entityName }} ${{ module.slugSingular }}, array $data, array $files) {
{% for item in items %}
{% if item.type == "date" %}
        ${{ module.slugSingular }}->set{{ item.slugInCamel }}(new \DateTime($data["{{ item.slug }}"]));
{% elseif item.type == "file" or item.type == "image" %}
        if (!empty($files["{{ item.slug }}"]) && $files["{{ item.slug }}"] instanceof UploadedFileInterface) {
            ${{ module.slugSingular }}->set{{ item.slugInCamel }}($this->uploadFile($files["{{ item.slug }}"]));
        }
        if (isset($data["{{ item.slug }}_delete"])) {
            ${{ module.slugSingular }}->set{{ item.slugInCamel }}("");
        }
{% elseif item.type == "bool" %}
        ${{ module.slugSingular }}->set{{ item.slugInCamel }}((bool) isset($data["{{ item.slug }}"])?$data["{{ item.slug }}"]:false);
{% else %}
        ${{ module.slugSingular }}->set{{ item.slugInCamel }}($data["{{ item.slug }}"]);
{% endif %}
{% endfor %}
    }

{% set break = false %}
{% for item in items if not break %}
{% if item.type == "file" or item.type == "image" %}
    private function uploadFile(UploadedFileInterface $file): string
    {
        $client_filename = $file->getClientFilename();
        $filename = md5($client_filename.time()) . "." . substr($client_filename, -4);
        $dir1 = substr($filename, 0, 2);
        $dir2 = substr($filename, 2, 2);
        $upload_dir = __DIR__ . "/../../../web/upload";
        $target = $upload_dir . "/" . $dir1 . "/" . $dir2 . "/" . $filename;

        if (!is_dir($upload_dir . "/" . $dir1)) {
            @mkdir($upload_dir . "/" . $dir1);
            @chmod($upload_dir . "/" . $dir1, 0777);
        }

        if (!is_dir($upload_dir . "/" . $dir1 . "/" . $dir2)) {
            @mkdir($upload_dir . "/" . $dir1 . "/" . $dir2);
            @chmod($upload_dir . "/" . $dir1 . "/" . $dir2, 0777);
        }

        if ($file->moveTo($target)) {
            @chmod($target, 0777);
            return $dir1 . "/" . $dir2 . "/" . $filename;
        }

        return "";
    }

{% set break = true %}
{% endif %}
{% endfor %}
}